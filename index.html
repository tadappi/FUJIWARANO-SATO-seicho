<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLB — OrbitControls + Object Autorotate + Axes</title>

  <!-- A-Frame 本体 -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- OrbitControls コンポーネント -->
  <script src="https://unpkg.com/aframe-orbit-controls@1.3.0/dist/aframe-orbit-controls.min.js"></script>

  <style>
    html,body{margin:0;height:100%}
    .hint{
      position:fixed;left:10px;bottom:10px;color:#e0e0e0;
      font:12px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:rgba(0,0,0,.35);padding:6px 8px;border-radius:6px
    }
  </style>
</head>
<body>
  <div class="hint">
    開始5秒静止→6秒移動→3秒静止→モデルが中心で自動回転<br>
    操作：左=回転／中=パン／ホイール=ズーム（放置で回転に復帰）
  </div>

  <a-scene renderer="colorManagement:true" background="color:#c2c2c2">
    <!-- ライト -->
    <a-entity light="type:ambient;intensity:0.6"></a-entity>
    <a-entity light="type:directional;intensity:0.9" position="2 4 2"></a-entity>

    <!-- モデル。自動回転はモデル側に付与（原点中心で回転） -->
    <a-entity id="modelRoot"
      position="0 0 0"
      auto-spin="speedDegPerSec:4; idleMs:3000; rampMs:1200; enabled:false">

      <!-- XYZ軸：モデルの子にして“一緒に回る” -->
      <a-entity axes-helper="size:10"></a-entity>

      <a-entity gltf-model="url(./seicho.glb)" position="0 0 0" rotation="0 0 0" scale="1 1 1"></a-entity>
    </a-entity>

    <!-- リグ：初期モーションはリグを動かす（カメラはその子） -->
    <a-entity id="rig"
      position="0 1.0 5"
      rotation="-35 0 0"
      animation__move="property: position; to: 0 3 15; dur: 6000; delay: 5000; easing: easeInOutQuad"
      animation__look="property: rotation; to: -25 0 0; dur: 6000; delay: 5000; easing: easeInOutQuad">

      <!-- カメラ：OrbitControls で“ターゲット(原点)を中心に”回る -->
      <a-entity
        id="cam"
        camera="fov:40"
        orbit-controls="
          target: 0 0 0;
          enableDamping: true;
          dampingFactor: 0.08;
          rotateSpeed: 0.3;
          zoomSpeed: 0.8;
          panSpeed: 0.8;
          minDistance: 2;
          maxDistance: 500;
          screenSpacePanning: true;
          enablePan: true;
          enableZoom: true;
          autoRotate: false
        ">
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ===== AxesHelper（赤X・緑Y・青Z） =====
    AFRAME.registerComponent('axes-helper', {
      schema: { size: {default: 1} },
      init: function () {
        const axes = new THREE.AxesHelper(this.data.size);
        this.el.setObject3D('mesh', axes);
      }
    });

    // ===== モデル自動回転（放置で再開・ゆるく立ち上げ） =====
    AFRAME.registerComponent('auto-spin', {
      schema: {
        speedDegPerSec:{default:4},
        idleMs:{default:3000},
        rampMs:{default:1200},
        enabled:{default:false}
      },
      init:function(){
        this.isActive=this.data.enabled;
        this._rampT=0; this._idleTimer=null;
        const pause=()=>this.pauseAutorotate();
        // ユーザー操作で一時停止
        window.addEventListener('pointerdown',pause);
        window.addEventListener('pointermove',pause);
        window.addEventListener('wheel',pause,{passive:true});
        window.addEventListener('keydown',pause);
        window.addEventListener('touchstart',pause,{passive:true});
        window.addEventListener('touchmove',pause,{passive:true});
      },
      pauseAutorotate:function(){
        this.isActive=false; this._rampT=0;
        if(this._idleTimer)clearTimeout(this._idleTimer);
        this._idleTimer=setTimeout(()=>{
          this.isActive=true; this._rampT=0;
        },this.data.idleMs);
      },
      tick:function(t,dt){
        if(!this.data.enabled||!this.isActive)return;
        const rot=this.el.getAttribute('rotation');
        const dsec=dt/1000;
        // 速度のなめらか立ち上げ
        let k;
        if(this._rampT<1){
          this._rampT=Math.min(1,this._rampT+dsec/(this.data.rampMs/1000));
          const x=this._rampT;
          k = x<0.5 ? 4*x*x*x : 1 - Math.pow(-2*x+2,3)/2; // easeInOutCubic
        } else k=1;
        rot.y += this.data.speedDegPerSec * k * dsec; // Yawのみ
        this.el.setAttribute('rotation',rot);
      },
      setEnabled:function(on){
        this.data.enabled=on;
        if(on)this.pauseAutorotate();
        else{
          this.isActive=false;
          if(this._idleTimer)clearTimeout(this._idleTimer);
        }
      }
    });

    // ===== シーケンス（A-Frameロード後に安全に実行） =====
    document.querySelector('a-scene').addEventListener('loaded',()=>{
      const rig=document.querySelector('#rig');
      const modelRoot=document.querySelector('#modelRoot');
      const auto=modelRoot.components['auto-spin'];

      // 初期モーション（5秒静止→6秒移動）完了 → 3秒待機 → 自動回転ON
      rig.addEventListener('animationcomplete__move',()=>{
        setTimeout(()=>{ auto.setEnabled(true); },3000);
      });
    });
  </script>
</body>
</html>
