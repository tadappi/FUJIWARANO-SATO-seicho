<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLB — Object Autorotate (Center Axis + Axes Helper)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html,body{margin:0;height:100%}
    .hint{
      position:fixed;left:10px;bottom:10px;color:#e0e0e0;
      font:12px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:rgba(0,0,0,.35);padding:6px 8px;border-radius:6px
    }
  </style>
</head>
<body>
  <div class="hint">
    開始5秒静止→6秒移動→3秒静止→<b>モデルが中心軸でゆっくり自転</b><br>
    XYZ軸（赤:X 緑:Y 青:Z）も表示
  </div>

  <a-scene renderer="colorManagement:true" background="color:#c2c2c2">
    <!-- ライト -->
    <a-entity light="type:ambient;intensity:0.6"></a-entity>
    <a-entity light="type:directional;intensity:0.9" position="2 4 2"></a-entity>

    <!-- XYZ軸表示 -->
    <a-entity axes-helper="size:10"></a-entity>

    <!-- モデル（中心で回転する） -->
    <a-entity id="modelRoot"
      auto-spin="speedDegPerSec:4; idleMs:3000; rampMs:1200; enabled:false"
      position="0 0 0">
      <a-entity gltf-model="url(./seicho.glb)" position="0 0 0" rotation="0 0 0" scale="1 1 1"></a-entity>
    </a-entity>

    <!-- カメラ -->
    <a-entity id="rig"
      position="0 1.0 5"
      rotation="-35 0 0"
      animation__move="property: position; to: 0 3 15; dur: 6000; delay: 5000; easing: easeInOutQuad"
      animation__look="property: rotation; to: -25 0 0; dur: 6000; delay: 5000; easing: easeInOutQuad">
      <a-entity camera="fov:40" look-controls="reverseMouseDrag:false; pointerLockEnabled:false"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ---------- 軸ヘルパー ----------
    AFRAME.registerComponent('axes-helper', {
      schema: { size: {default: 1} },
      init: function () {
        const size = this.data.size;
        const axesHelper = new THREE.AxesHelper(size);
        this.el.setObject3D('mesh', axesHelper);
      }
    });

    // ---------- モデル自動回転 ----------
    AFRAME.registerComponent('auto-spin', {
      schema: {
        speedDegPerSec:{default:4},
        idleMs:{default:3000},
        rampMs:{default:1200},
        enabled:{default:false}
      },
      init:function(){
        this.isActive=this.data.enabled;
        this._rampT=0;
        this._idleTimer=null;
        const pause=()=>this.pauseAutorotate();
        window.addEventListener('pointerdown',pause);
        window.addEventListener('pointermove',pause);
        window.addEventListener('wheel',pause,{passive:true});
        window.addEventListener('keydown',pause);
        window.addEventListener('touchstart',pause,{passive:true});
        window.addEventListener('touchmove',pause,{passive:true});
      },
      pauseAutorotate:function(){
        this.isActive=false;
        this._rampT=0;
        if(this._idleTimer)clearTimeout(this._idleTimer);
        this._idleTimer=setTimeout(()=>{
          this.isActive=true;
          this._rampT=0;
        },this.data.idleMs);
      },
      tick:function(t,dt){
        if(!this.data.enabled||!this.isActive)return;
        const rot=this.el.getAttribute('rotation');
        const dsec=dt/1000;
        if(this._rampT<1){
          this._rampT=Math.min(1,this._rampT+dsec/(this.data.rampMs/1000));
          const k=this._rampT;
          this._speedFactor=k<0.5?4*k*k*k:1-Math.pow(-2*k+2,3)/2;
        }else{this._speedFactor=1;}
        rot.y+=this.data.speedDegPerSec*this._speedFactor*dsec;
        this.el.setAttribute('rotation',rot);
      },
      setEnabled:function(on){
        this.data.enabled=on;
        if(on)this.pauseAutorotate();
        else{
          this.isActive=false;
          if(this._idleTimer)clearTimeout(this._idleTimer);
        }
      }
    });

    // ---------- シーケンス制御 ----------
    document.querySelector('a-scene').addEventListener('loaded',()=>{
      const rig=document.querySelector('#rig');
      const modelRoot=document.querySelector('#modelRoot');
      const auto=modelRoot.components['auto-spin'];

      rig.addEventListener('animationcomplete__move',()=>{
        setTimeout(()=>{ auto.setEnabled(true); },3000);
      });
    });
  </script>
</body>
</html>
