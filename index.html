<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLB — OrbitControls (extras) + Object Autorotate + Axes</title>

  <!-- A-Frame 1.5.0 -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- OrbitControls を含む aframe-extras（1.5と相性◎） -->
  <script src="https://unpkg.com/aframe-extras@7.7.0/dist/aframe-extras.min.js"></script>

  <style>
    html,body{margin:0;height:100%}
    .hint{
      position:fixed;left:10px;bottom:10px;color:#e0e0e0;
      font:12px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:rgba(0,0,0,.35);padding:6px 8px;border-radius:6px
    }
  </style>
</head>
<body>
  <div class="hint">
    開始5秒静止→6秒移動→3秒静止→モデルが中心で自動回転<br>
    操作：左=回転／中=パン／ホイール=ズーム（放置で再開）
  </div>

  <a-scene renderer="colorManagement:true" background="color:#c2c2c2">
    <!-- ライト -->
    <a-entity light="type:ambient;intensity:0.6"></a-entity>
    <a-entity light="type:directional;intensity:0.9" position="2 4 2"></a-entity>

    <!-- モデル：原点中心で回転。XYZ軸は子にして一緒に回す -->
    <a-entity id="modelRoot"
      position="0 0 0"
      auto-spin="speedDegPerSec:4; idleMs:3000; rampMs:1200; enabled:false">
      <a-entity axes-helper="size:10"></a-entity>
      <a-entity gltf-model="url(./seicho.glb)" position="0 0 0" rotation="0 0 0" scale="1 1 1"></a-entity>
    </a-entity>

    <!-- カメラ・リグ：初期モーションはリグを動かす -->
    <a-entity id="rig"
      position="0 1.0 5"
      rotation="-35 0 0"
      animation__move="property: position; to: 0 3 15; dur: 6000; delay: 5000; easing: easeInOutQuad"
      animation__look="property: rotation; to: -25 0 0; dur: 6000; delay: 5000; easing: easeInOutQuad">

      <!-- カメラ：aframe-extras の orbit-controls を使用 -->
      <a-entity id="cam" camera="fov:40"
        orbit-controls="
          target: 0 0 0;
          enableDamping: true;
          dampingFactor: 0.1;
          rotateSpeed: 0.35;
          zoomSpeed: 0.9;
          panSpeed: 0.9;
          screenSpacePanning: true;
          minDistance: 2;
          maxDistance: 500;
          enablePan: true;
          enableZoom: true;
          autoRotate: false">
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ---- XYZ軸（赤X・緑Y・青Z） ----
    AFRAME.registerComponent('axes-helper', {
      schema: { size: {default: 1} },
      init() {
        const axes = new THREE.AxesHelper(this.data.size);
        this.el.setObject3D('mesh', axes);
      }
    });

    // ---- モデルの“アイドル時”自動回転（ユーザー操作で一時停止→放置で再開）----
    AFRAME.registerComponent('auto-spin', {
      schema: { speedDegPerSec:{default:4}, idleMs:{default:3000}, rampMs:{default:1200}, enabled:{default:false} },
      init(){
        this.isActive=this.data.enabled; this._rampT=0; this._idleTimer=null;
        const pause=()=>this.pauseAutorotate();
        window.addEventListener('pointerdown',pause);
        window.addEventListener('pointermove',pause);
        window.addEventListener('wheel',pause,{passive:true});
        window.addEventListener('keydown',pause);
        window.addEventListener('touchstart',pause,{passive:true});
        window.addEventListener('touchmove',pause,{passive:true});
      },
      pauseAutorotate(){
        this.isActive=false; this._rampT=0;
        if(this._idleTimer) clearTimeout(this._idleTimer);
        this._idleTimer=setTimeout(()=>{ this.isActive=true; this._rampT=0; }, this.data.idleMs);
      },
      tick(t,dt){
        if(!this.data.enabled || !this.isActive) return;
        const rot=this.el.getAttribute('rotation');
        const dsec=dt/1000;
        let k=1;
        if(this._rampT<1){
          this._rampT=Math.min(1,this._rampT+dsec/(this.data.rampMs/1000));
          const x=this._rampT; k = x<0.5 ? 4*x*x*x : 1 - Math.pow(-2*x+2,3)/2; // easeInOutCubic
        }
        rot.y += this.data.speedDegPerSec * k * dsec;
        this.el.setAttribute('rotation',rot);
      },
      setEnabled(on){
        this.data.enabled=on;
        if(on) this.pauseAutorotate();
        else {
          this.isActive=false;
          if(this._idleTimer) clearTimeout(this._idleTimer);
        }
      }
    });

    // ---- シーケンス：A-Frameロード後に安全に実行 ----
    document.querySelector('a-scene').addEventListener('loaded', ()=>{
      const rig = document.querySelector('#rig');
      const modelRoot = document.querySelector('#modelRoot');
      const auto = modelRoot.components['auto-spin'];
      rig.addEventListener('animationcomplete__move', ()=>{
        setTimeout(()=>{ auto.setEnabled(true); }, 3000);
      });
    });
  </script>
</body>
</html>
